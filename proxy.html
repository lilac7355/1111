<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“¡å·¥è«‹å‡ä»£ç†äººæŸ¥æ‰¾ç³»çµ± (è¡Œå‹•ç‰ˆå„ªåŒ–)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ç¢ºä¿å­—é«”åœ¨æ‰‹æ©Ÿä¸Šæ¸…æ™° */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* é‡å°è¡Œå‹•è£ç½®ï¼Œç¢ºä¿ Select å’Œ Input å…ƒç´ æœ‰è¶³å¤ çš„é«˜åº¦åœ¨æ‰‹æ©Ÿä¸Šé»æ“Š */
        .p-3 {
            padding: 0.75rem; /* å¢åŠ é»æ“Šå€åŸŸ */
        }
    </style>
</head>
<body class="min-h-screen p-2 sm:p-4 md:p-6 bg-gray-50">

    <div class="max-w-xl mx-auto bg-white shadow-lg rounded-xl overflow-hidden">
        
        <header class="bg-indigo-600 p-4 text-white">
            <h1 class="text-xl font-bold">ä»£ç†äººæ‰‹å‹•é¸æ“‡ç³»çµ±</h1>
            <p class="text-indigo-200 text-sm mt-1">è«‹è¼¸å…¥è«‹å‡è³‡è¨Šï¼Œä¸¦å¾å€™é¸åå–®ä¸­é¸æ“‡ä»£ç†äººã€‚</p>
        </header>

        <main class="p-4 space-y-4">
            
            <div id="result-box" class="min-h-[80px] p-3 border rounded-lg bg-yellow-50 border-yellow-300 text-gray-700 text-sm">
                <p class="font-semibold text-yellow-700">ğŸ” è«‹å¡«å¯«ä¸Šæ–¹æ¬„ä½å¾Œï¼Œé»æ“Šã€ŒæŸ¥æ‰¾ä»£ç†äººã€æŒ‰éˆ•ã€‚</p>
            </div>

            <form id="proxy-form" class="space-y-4">
                
                <div>
                    <label for="employeeId" class="block text-sm font-medium text-gray-700 mb-1">
                        è«‹å‡å“¡å·¥å§“å (ID)
                    </label>
                    <select id="employeeId" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
                        <option value="" disabled selected>è«‹é¸æ“‡è«‹å‡å“¡å·¥...</option>
                    </select>
                </div>

                <div>
                    <label for="leaveType" class="block text-sm font-medium text-gray-700 mb-1">
                        å‡åˆ¥é¸æ“‡
                    </label>
                    <select id="leaveType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
                        <option value="" disabled selected>è«‹é¸æ“‡å‡åˆ¥...</option>
                    </select>
                </div>

                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">
                            é–‹å§‹æ—¥æœŸ
                        </label>
                        <input type="date" id="startDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
                    </div>

                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">
                            çµæŸæ—¥æœŸ
                        </label>
                        <input type="date" id="endDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
                    </div>
                </div>

                <button type="button" id="searchButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                    æŸ¥æ‰¾ä»£ç†äºº
                </button>
            </form>
            
            <div id="selection-area" class="hidden space-y-4 pt-4 border-t border-gray-100">
                <div>
                    <label for="substituteSelect" class="block text-sm font-medium text-gray-700 mb-1 font-bold">
                        ç¬¬äºŒæ­¥ï¼šå¾å¯ç”¨åå–®ä¸­é¸æ“‡æœ€çµ‚ä»£ç†äºº
                    </label>
                    <select id="substituteSelect" class="w-full p-3 border border-indigo-500 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
                        <option value="" disabled selected>è«‹é¸æ“‡ä¸€ä½ä»£ç†äºº...</option>
                    </select>
                </div>
                <button type="button" id="confirmButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 focus:outline-none focus:ring-4 focus:ring-green-300">
                    ç¢ºèªé¸æ“‡é€™ä½ä»£ç†äºº
                </button>
            </div>

            <div id="active-leaves-area" class="mt-6 pt-4 border-t border-gray-100">
                <h3 class="text-base font-bold text-gray-800 mb-2">ğŸ“… ç•¶å‰ä¼‘å‡äººå“¡èˆ‡ä»£ç†äººè·è²¬</h3>
                <ul id="active-leaves-list" class="space-y-2 text-xs">
                    <li class="text-gray-500">æ­£åœ¨è¼‰å…¥è«‹å‡è³‡è¨Š...</li>
                </ul>
            </div>
            
            <div class="pt-4 border-t border-gray-100 mt-6">
                <p class="text-xs text-gray-400">
                    **è¡çªæª¢æŸ¥ï¼š** åªæœ‰ç•¶ä»£ç†äººä¸åœ¨è«‹æ±‚çš„æ—¥æœŸç¯„åœå…§ä¼‘å‡æ™‚ï¼Œæ‰æœƒå‡ºç¾åœ¨åå–®ä¸­ã€‚
                </p>
            </div>
        </main>
    </div>

    <script>
        // --- æ ¸å¿ƒè³‡æ–™å®šç¾© (Data Definition) ---
        const LEAVE_TYPES = [
            "ä¼‘å‡ (Annual Leave)",
            "ç—…å‡ (Sick Leave)",
            "äº‹å‡ (Personal Leave)",
            "å–ªå‡ (Bereavement Leave)",
            "èº«å¿ƒèª¿é©å‡ (Mental Health Leave)"
        ];

        const SPECIAL_AGENT_A_ID = "E001"; // è¨±æ˜ç¥¥
        const SPECIAL_AGENT_B_ID = "E003"; // å‘‚ä¿¡å¿ 

        const employeeData = [
            {"id": "E001", "name": "è¨±æ˜ç¥¥"}, 
            {"id": "E002", "name": "ç‹å­æº"},
            {"id": "E003", "name": "å‘‚ä¿¡å¿ "},
            {"id": "E004", "name": "å³æ¬£å³°"},
            {"id": "E005", "name": "è¨±æ™¯ç¿”"},
            {"id": "E006", "name": "åŠ‰è¨“å®"},
            {"id": "E007", "name": "è¨±é‡‹æ™Ÿ"},
            {"id": "E008", "name": "è¨±å®—æ–‡"},
            {"id": "E009", "name": "åŠ‰æŸæ¦•"},
            {"id": "E010", "name": "æ¥Šç„œæ·µ"},
            {"id": "E011", "name": "è¬å‚‘å„’"},
            {"id": "E012", "name": "è˜‡ä¿Šç‘‹"},
        ];

        // æ´»èºè«‹å‡è¨˜éŒ„ (æ¨¡æ“¬è³‡æ–™åº«ä¸­å·²æœ‰çš„ä¼‘å‡å®‰æ’)
        const activeLeaves = []; 

        // --- æ ¸å¿ƒé‚è¼¯å‡½æ•¸ (Core Logic Functions) ---

        /** æª¢æŸ¥æ½›åœ¨ä»£ç†äººæ˜¯å¦åœ¨è«‹æ±‚çš„æ—¥æœŸç¯„åœå…§å·²å®‰æ’ä¼‘å‡ */
        function isAvailable(employeeId, startDateStr, endDateStr, leaves) {
            const reqStart = Date.parse(startDateStr);
            const reqEnd = Date.parse(endDateStr);

            if (isNaN(reqStart) || isNaN(reqEnd) || reqStart > reqEnd) {
                return true; 
            }

            for (const leave of leaves) {
                if (leave.id === employeeId) {
                    const leaveStart = Date.parse(leave.start);
                    const leaveEnd = Date.parse(leave.end);

                    if (reqStart <= leaveEnd && reqEnd >= leaveStart) {
                        return false; 
                    }
                }
            }
            return true; 
        }

        /** å°‹æ‰¾ä¸¦è¿”å›æ‰€æœ‰å¯ç”¨çš„ä»£ç†äººåå–® (æŒ‰å„ªå…ˆç´šæ’åº)ã€‚ */
        function getAvailableCandidates(employeeIdToFind, data, startDate, endDate, activeLeaves) {
            const leavingEmployee = data.find(emp => emp.id === employeeIdToFind);
            const header = `${leavingEmployee.name} (${leavingEmployee.id}) è«‹å‡ (${startDate} è‡³ ${endDate})`;
            const candidates = [];

            // 1. è™•ç†ç‰¹æ®Šä»£ç†è¦å‰‡ (äº’ç‚ºæŒ‡å®šä»£ç†)
            if (employeeIdToFind === SPECIAL_AGENT_A_ID) { 
                if (isAvailable(SPECIAL_AGENT_B_ID, startDate, endDate, activeLeaves)) {
                    const substitute = data.find(emp => emp.id === SPECIAL_AGENT_B_ID);
                    substitute.type = 'æŒ‡å®šä»£ç†äºº';
                    candidates.push(substitute);
                    return { header, candidates }; 
                } else {
                    return { header, candidates: null, error: "éŒ¯èª¤ï¼šè¨±æ˜ç¥¥çš„æŒ‡å®šä»£ç†äººå‘‚ä¿¡å¿ åœ¨è©²æ—¥æœŸç¯„åœå…§æ­£åœ¨ä¼‘å‡ã€‚" };
                }
            } else if (employeeIdToFind === SPECIAL_AGENT_B_ID) { 
                if (isAvailable(SPECIAL_AGENT_A_ID, startDate, endDate, activeLeaves)) {
                    const substitute = data.find(emp => emp.id === SPECIAL_AGENT_A_ID);
                    substitute.type = 'æŒ‡å®šä»£ç†äºº';
                    candidates.push(substitute);
                    return { header, candidates }; 
                } else {
                    return { header, candidates: null, error: "éŒ¯èª¤ï¼šå‘‚ä¿¡å¿ çš„æŒ‡å®šä»£ç†äººè¨±æ˜ç¥¥åœ¨è©²æ—¥æœŸç¯„åœå…§æ­£åœ¨ä¼‘å‡ã€‚" };
                }
            }

            // 2. è™•ç†å…¶ä»–å“¡å·¥çš„ä»£ç†è¦å‰‡ (ç‰¹æ¬Šå„ªå…ˆ)
            for (const specialId of [SPECIAL_AGENT_A_ID, SPECIAL_AGENT_B_ID]) {
                if (isAvailable(specialId, startDate, endDate, activeLeaves)) {
                    const specialAgent = data.find(emp => emp.id === specialId);
                    candidates.push({...specialAgent, type: 'ç‰¹æ¬Šä»£ç†äºº (é«˜éš)'});  
                }
            }
            
            // 3. å°‹æ‰¾æ‰€æœ‰å…¶ä»–å¯ç”¨çš„æ™®é€šå“¡å·¥
            data.forEach(emp => {
                const isSelf = emp.id === employeeIdToFind;
                const isSpecialAgent = emp.id === SPECIAL_AGENT_A_ID || emp.id === SPECIAL_AGENT_B_ID;
                
                if (!isSelf && !isSpecialAgent && isAvailable(emp.id, startDate, endDate, activeLeaves)) {
                    if (!candidates.some(c => c.id === emp.id)) { 
                        candidates.push({...emp, type: 'ä¸€èˆ¬å€™è£œå“¡å·¥'});
                    }
                }
            });

            if (candidates.length === 0) {
                 return { header, candidates: null, error: "æ‰¾ä¸åˆ°ä»»ä½•å¯ç”¨çš„ä»£ç†äºº (æ‰€æœ‰å“¡å·¥åœ¨è©²æ—¥æœŸéƒ½å·²ä¼‘å‡)ã€‚" };
            }

            return { header, candidates };
        }

        /** è™•ç†å–æ¶ˆè«‹å‡çš„é‚è¼¯ */
        function cancelLeave(leaveKey) {
            const [employeeId, startDate] = leaveKey.split('|');

            const indexToRemove = activeLeaves.findIndex(leave => 
                leave.id === employeeId && leave.start === startDate
            );

            if (indexToRemove > -1) {
                activeLeaves.splice(indexToRemove, 1);
                displayActiveLeaves(); 
                renderResult('success', 'è«‹å‡å·²å–æ¶ˆ', `å“¡å·¥ ${getEmployeeNameById(employeeId)} (${employeeId}) å¾ ${startDate} é–‹å§‹çš„è«‹å‡è¨˜éŒ„å·²æˆåŠŸå–æ¶ˆã€‚`);
            } else {
                renderResult('error', 'å–æ¶ˆå¤±æ•—', 'æ‰¾ä¸åˆ°å°æ‡‰çš„è«‹å‡è¨˜éŒ„ã€‚');
            }
        }


        // --- UI è™•ç†é‚è¼¯ (UI Logic) ---
        const employeeSelect = document.getElementById('employeeId');
        const leaveSelect = document.getElementById('leaveType');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const searchButton = document.getElementById('searchButton');
        const confirmButton = document.getElementById('confirmButton');
        const resultBox = document.getElementById('result-box');
        const selectionArea = document.getElementById('selection-area');
        const substituteSelect = document.getElementById('substituteSelect');
        const activeLeavesList = document.getElementById('active-leaves-list'); 

        
        let currentQueryInfo = {};

        function getEmployeeNameById(id) {
            const employee = employeeData.find(emp => emp.id === id);
            return employee ? employee.name : id;
        }

        // å¡«å……ä¸‹æ‹‰é¸å–®
        function populateSelectors() {
            employeeData.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.name} (${emp.id})`; 
                employeeSelect.appendChild(option);
            });

            LEAVE_TYPES.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                leaveSelect.appendChild(option);
            });
        }

        // é¡¯ç¤ºç•¶å‰ä¼‘å‡äººå“¡èˆ‡ä»£ç†äººåˆ—è¡¨
        function displayActiveLeaves() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); 

            const filteredLeaves = activeLeaves.filter(leave => {
                const [year, month, day] = leave.end.split('-').map(Number);
                const leaveEndDate = new Date(Date.UTC(year, month - 1, day)); 
                const todayUTC = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));

                return leaveEndDate.getTime() >= todayUTC.getTime();
            });


            if (filteredLeaves.length === 0) {
                activeLeavesList.innerHTML = '<li class="text-gray-500 p-2 border border-gray-200 rounded-lg">ç›®å‰æ²’æœ‰å“¡å·¥åœ¨ä¼‘å‡ä¸­ã€‚</li>';
                return;
            }

            const listItems = filteredLeaves.map(leave => { 
                const name = getEmployeeNameById(leave.id);
                const proxyName = getEmployeeNameById(leave.proxyId); 

                const leaveKey = `${leave.id}|${leave.start}`;

                return `<li class="p-2 bg-gray-50 rounded-lg border border-gray-200 shadow-sm flex justify-between items-center">
                            <div>
                                <div class="font-semibold text-indigo-700">${name} (${leave.id})</div>
                                <div class="mt-0.5 ml-2 text-xs text-gray-600">
                                    æœŸé–“ï¼š<span class="text-red-600 font-medium">${leave.start}</span> ~ <span class="text-red-600 font-medium">${leave.end}</span>
                                </div>
                                <div class="mt-0.5 ml-2 text-xs text-gray-600">
                                    ä»£ç†äººï¼š<span class="text-green-600 font-medium">${proxyName} (${leave.proxyId})</span>
                                </div>
                            </div>
                            <button type="button" 
                                    class="cancel-leave-btn bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-1 px-2 rounded-lg transition duration-150"
                                    data-leave-key="${leaveKey}">
                                å–æ¶ˆ
                            </button>
                        </li>`;
            }).join('');

            activeLeavesList.innerHTML = listItems;
        }

        // æ¸²æŸ“çµæœåˆ°UI
        function renderResult(status, header, message) {
            let bgColor = 'bg-yellow-50';
            let borderColor = 'border-yellow-300';
            let textColor = 'text-gray-700';
            let icon = 'ğŸ”';

            if (status === 'success') {
                bgColor = 'bg-green-50';
                borderColor = 'border-green-300';
                textColor = 'text-green-800';
                icon = 'âœ…';
            } else if (status === 'fail' || status === 'error') {
                bgColor = 'bg-red-50';
                borderColor = 'border-red-300';
                textColor = 'text-red-800';
                icon = 'âŒ';
            } else if (status === 'pending') {
                bgColor = 'bg-blue-50';
                borderColor = 'border-blue-300';
                textColor = 'text-blue-800';
                icon = 'ğŸ“';
            }

            let formattedMessage = message.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

            let html = `<div class="font-bold text-base mb-1 ${textColor}">${icon} ${header || 'ç³»çµ±è¨Šæ¯'}</div>`;
            html += `<p class="text-sm">${formattedMessage}</p>`;
            
            resultBox.className = `min-h-[80px] p-3 border rounded-lg ${bgColor} ${borderColor} ${textColor}`;
            resultBox.innerHTML = html;
        }

        // --- éšæ®µ 1: æŸ¥æ‰¾å€™é¸äºº ---
        searchButton.addEventListener('click', () => {
            const employeeId = employeeSelect.value;
            const leaveType = leaveSelect.value;
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            selectionArea.classList.add('hidden');

            if (!employeeId || !leaveType || !startDate || !endDate) {
                renderResult('error', 'è¼¸å…¥éŒ¯èª¤', 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ã€‚');
                return;
            }

            if (Date.parse(startDate) > Date.parse(endDate)) {
                renderResult('error', 'æ—¥æœŸç„¡æ•ˆ', 'é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸã€‚');
                return;
            }

            const result = getAvailableCandidates(employeeId, employeeData, startDate, endDate, activeLeaves);
            
            currentQueryInfo = { employeeId, leaveType, startDate, endDate, header: result.header };

            if (result.error) {
                renderResult('fail', result.header, result.error);
                return;
            }
            
            substituteSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡ä¸€ä½ä»£ç†äºº...</option>';
            
            result.candidates.forEach(candidate => {
                const option = document.createElement('option');
                option.value = candidate.id;
                option.textContent = `${candidate.name} (${candidate.id}) - ${candidate.type}`;
                substituteSelect.appendChild(option);
            });

            selectionArea.classList.remove('hidden');
            renderResult('pending', result.header, `âœ… æˆåŠŸæ‰¾åˆ° ${result.candidates.length} ä½å¯ç”¨ä»£ç†äººã€‚è«‹å¾ä¸‹æ–¹çš„é¸å–®ä¸­é¸æ“‡ä¸€ä½ã€‚`);
        });

        // --- éšæ®µ 2: ç¢ºèªæœ€çµ‚é¸æ“‡ ---
        confirmButton.addEventListener('click', () => {
            const selectedAgentId = substituteSelect.value;

            if (!selectedAgentId) {
                renderResult('error', currentQueryInfo.header, 'è«‹å…ˆå¾ä¸‹æ‹‰å¼é¸å–®ä¸­é¸æ“‡ä¸€ä½ä»£ç†äººï¼');
                return;
            }

            const selectedAgent = employeeData.find(emp => emp.id === selectedAgentId);
            const originalEmployee = employeeData.find(emp => emp.id === currentQueryInfo.employeeId);
            
            const isSpecialAssignment = 
                (currentQueryInfo.employeeId === SPECIAL_AGENT_A_ID && selectedAgentId === SPECIAL_AGENT_B_ID) ||
                (currentQueryInfo.employeeId === SPECIAL_AGENT_B_ID && selectedAgentId === SPECIAL_AGENT_A_ID);
            
            let message = '';

            if (isSpecialAssignment) {
                 message = `**è·å‹™ä»£ç†äººï¼š** ${selectedAgent.name} ï¼ˆID: ${selectedAgent.id}ï¼‰ **å·²æ ¹æ“šç‰¹æ®Šè¦å‰‡æŒ‡å®šã€‚**`;
            } else if (selectedAgentId === SPECIAL_AGENT_A_ID || selectedAgentId === SPECIAL_AGENT_B_ID) {
                 message = `**è·å‹™ä»£ç†äººï¼š** ${selectedAgent.name} ï¼ˆID: ${selectedAgent.id}ï¼‰ **å·²æŒ‡å®šç‚ºç‰¹æ¬Šä»£ç†äººã€‚**`;
            } else {
                 message = `**è·å‹™ä»£ç†äººï¼š** ${selectedAgent.name} ï¼ˆID: ${selectedAgent.id}ï¼‰ **å·²æŒ‡å®šç‚ºå€™è£œä»£ç†äººã€‚**`;
            }

            renderResult('success', 
                `${originalEmployee.name} (${originalEmployee.id}) è«‹ã€${currentQueryInfo.leaveType}ã€‘ç¢ºèªçµæœ`,
                message + `<br>è«‹å‡å€é–“ï¼š${currentQueryInfo.startDate} è‡³ ${currentQueryInfo.endDate}`
            );

            // å°‡ç¢ºèªçš„è«‹å‡è¨˜éŒ„æ·»åŠ åˆ° activeLeaves åˆ—è¡¨ä¸­
            const newLeave = {
                id: currentQueryInfo.employeeId,
                start: currentQueryInfo.startDate,
                end: currentQueryInfo.endDate,
                proxyId: selectedAgentId,
            };

            activeLeaves.push(newLeave);

            displayActiveLeaves(); 

            selectionArea.classList.add('hidden');
        });

        // --- å–æ¶ˆè«‹å‡æŒ‰éˆ•çš„äº‹ä»¶å§”æ´¾ ---
        activeLeavesList.addEventListener('click', (event) => {
            const button = event.target.closest('.cancel-leave-btn');
            if (button) {
                const leaveKey = button.dataset.leaveKey;
                if (leaveKey) {
                    cancelLeave(leaveKey);
                }
            }
        });

        // åˆå§‹åŒ–
        populateSelectors();
        displayActiveLeaves(); 
    </script>
</body>
</html>